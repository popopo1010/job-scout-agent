# 音声データフィードバックシステム 要件定義書

## 1. 概要

### 1.1 目的

CA（キャリアアドバイザー）の営業通話音声データを直接格納し、自動的に文字起こし・分析・フィードバック生成を行うシステムを構築する。

### 1.2 背景

現在のフィードバックシステム（システム2）は、書き起こし済みテキストファイル（.txt）を処理する仕組みになっている。しかし、以下の課題がある：

- **手動での文字起こし作業が必要**: Zoom等から書き起こしファイルをダウンロードし、手動で配置する必要がある
- **リアルタイム性の欠如**: 文字起こし完了までフィードバック生成ができない
- **作業負荷**: CAやマネージャーが手動でファイル管理を行う必要がある

音声データを直接格納することで、これらの課題を解決し、より自動化されたフィードバック生成を実現する。

### 1.3 システムの位置づけ

本システムは、既存の**システム2: フィードバックシステム**を拡張するものである。

```
[音声データ格納] 
    ↓
[音声→テキスト変換（文字起こし）]
    ↓
[既存フィードバック生成フロー]
    ↓
[フィードバック出力（Slack送信等）]
```

---

## 2. 機能要件

### 2.1 音声データの格納と管理

#### F-AF-001: 音声ファイルのアップロード・保存
- **優先度**: 高
- **説明**: CAの営業通話音声ファイルをアップロードし、保存する機能
- **詳細**:
  - 音声ファイルのアップロードを受け付ける
  - ファイル名からメタデータ（日付、CA ID等）を抽出
  - 適切なディレクトリ構造で保存
  - 重複チェック機能

#### F-AF-002: 対応音声形式
- **優先度**: 高
- **説明**: サポートする音声ファイル形式
- **詳細**:
  - `.m4a` (iOS録音、Zoom録音)
  - `.mp3` (一般的な音声形式)
  - `.wav` (高品質音声)
  - `.webm` (ブラウザ録音)
  - その他の形式は必要に応じて追加

#### F-AF-003: 音声ファイルのメタデータ管理
- **優先度**: 中
- **説明**: 音声ファイルに関連する情報を管理
- **詳細**:
  - CA ID
  - 通話日時
  - 通話相手（求職者名）
  - 通話時間（自動算出）
  - ファイルサイズ
  - アップロード日時
  - 処理ステータス（未処理、文字起こし中、完了、失敗）

#### F-AF-004: ファイル命名規則
- **優先度**: 高
- **説明**: 音声ファイルの命名規則を定義
- **詳細**:
  ```
  形式1（推奨）:
  {YYYY-MM-DD}_{CA_ID}_{会議識別子}.{拡張子}
  例: 2025-01-15_CA001_client-call-001.m4a

  形式2（ファイル名から自動抽出）:
  任意のファイル名 → メタデータを手動入力または自動抽出
  ```

#### F-AF-005: ディレクトリ構造
- **優先度**: 高
- **説明**: 音声ファイルの保存ディレクトリ構造
- **詳細**:
  ```
  data/
  └── audio/
      ├── pending/              # 未処理の音声ファイル
      │   ├── 2025-01-15_CA001_call-001.m4a
      │   └── 2025-01-15_CA002_call-002.m4a
      ├── processing/           # 処理中（文字起こし中）
      ├── transcripts/          # 文字起こし済みテキスト（自動生成）
      │   └── 2025-01-15_CA001_call-001.txt
      ├── processed/            # 処理完了（音声ファイル）
      └── failed/               # 処理失敗
  ```

### 2.2 音声→テキスト変換（文字起こし）

#### F-AF-006: 自動文字起こし処理
- **優先度**: 高
- **説明**: 音声ファイルを自動的にテキストに変換
- **詳細**:
  - 待機中の音声ファイルを検出
  - 文字起こしAPIを呼び出し
  - 文字起こし結果をテキストファイルとして保存
  - 処理ステータスを更新

#### F-AF-007: 文字起こしサービスの選択
- **優先度**: 高
- **説明**: 使用する文字起こしAPI/サービス
- **詳細**:
  - **優先候補1**: OpenAI Whisper API
    - 高精度
    - 日本語対応
    - コスト: $0.006/分
  - **優先候補2**: Google Cloud Speech-to-Text
    - 高精度
    - 日本語対応
    - コスト: 従量課金
  - **優先候補3**: Azure Speech Services
    - 高精度
    - 日本語対応
    - コスト: 従量課金
  - **フォールバック**: ローカルWhisper（APIキー不要、精度はやや低い）

#### F-AF-008: 文字起こし精度の向上
- **優先度**: 中
- **説明**: 文字起こしの精度を向上させる機能
- **詳細**:
  - 電気工事士関連の専門用語辞書
  - CA名、会社名などの固有名詞辞書
  - 句読点の自動補完
  - 話者識別（CAと求職者の区別）

#### F-AF-009: 文字起こし結果の編集機能
- **優先度**: 低
- **説明**: 文字起こし結果を手動で編集できる機能
- **詳細**:
  - Web UIまたはCLIでテキスト編集
  - 編集履歴の保存
  - 再処理のトリガー

### 2.3 既存フィードバックシステムとの統合

#### F-AF-010: 自動フィードバック生成
- **優先度**: 高
- **説明**: 文字起こし完了後、自動的に既存のフィードバック生成フローを実行
- **詳細**:
  - 文字起こしテキストを `data/transcripts/pending/` に配置
  - 既存の `FeedbackEngine` を呼び出し
  - フィードバック生成完了後に音声ファイルを `processed/` に移動

#### F-AF-011: 処理フロー全体の自動化
- **優先度**: 高
- **説明**: 音声アップロードからフィードバック生成まで自動実行
- **詳細**:
  ```
  1. 音声ファイルアップロード
  2. ファイル検証・メタデータ抽出
  3. pending/ に保存
  4. 文字起こし処理開始
  5. 文字起こし完了 → transcripts/ に保存
  6. 既存フィードバック生成フロー実行
  7. フィードバック生成完了
  8. 音声ファイルを processed/ に移動
  9. Slack通知送信
  ```

### 2.4 エラーハンドリングとリトライ

#### F-AF-012: 文字起こし失敗時の処理
- **優先度**: 中
- **説明**: 文字起こしが失敗した場合の処理
- **詳細**:
  - エラーログの記録
  - 失敗したファイルを `failed/` に移動
  - 管理者への通知
  - リトライ機能（最大3回）

#### F-AF-013: 部分的な文字起こし失敗の対応
- **優先度**: 低
- **説明**: 音声ファイルの一部が文字起こしできない場合
- **詳細**:
  - 文字起こしできた部分は保存
  - 失敗箇所を明示
  - 警告を付けてフィードバック生成を続行

---

## 3. 非機能要件

### 3.1 パフォーマンス

#### NF-AF-001: 文字起こし処理時間
- **目標**: 1時間の音声ファイルを10分以内に処理
- **優先度**: 中

#### NF-AF-002: 同時処理数
- **目標**: 最大5ファイルまで同時処理
- **優先度**: 低

### 3.2 セキュリティ

#### NF-AF-003: 音声ファイルの機密性保護
- **要件**: 音声ファイルには個人情報が含まれるため、適切なアクセス制御が必要
- **詳細**:
  - ファイルシステムレベルのアクセス制限
  - 暗号化保存（オプション）
  - アクセスログの記録

#### NF-AF-004: APIキーの安全な管理
- **要件**: 文字起こしAPIキーは環境変数で管理
- **詳細**:
  - `.env` ファイルでの管理
  - Gitへのコミット禁止
  - 本番環境ではシークレット管理サービスを利用

### 3.3 ストレージ

#### NF-AF-005: ストレージ容量
- **見積もり**: 
  - 1時間の音声ファイル（m4a）: 約30-50MB
  - 月間100件 × 平均30分 = 約1.5-2.5GB/月
  - 年換算: 約18-30GB/年
- **要件**: 最低100GBのストレージを確保

#### NF-AF-006: ファイル保持期間
- **要件**: 処理完了後、音声ファイルは3ヶ月間保持
- **詳細**:
  - 3ヶ月経過後は自動アーカイブまたは削除
  - 文字起こしテキストは長期保存可能

### 3.4 可用性

#### NF-AF-007: サービス可用性
- **目標**: 99%以上の稼働率
- **優先度**: 中

#### NF-AF-008: バックアップ
- **要件**: 音声ファイルとメタデータの定期的なバックアップ
- **詳細**:
  - 日次バックアップ
  - 復元テストの実施

---

## 4. 入力データ

### 4.1 音声ファイル

- **形式**: `.m4a`, `.mp3`, `.wav`, `.webm` 等
- **サイズ制限**: 最大500MB/ファイル
- **長さ制限**: 最大2時間/ファイル
- **アップロード方法**: 
  - コマンドライン（CLI）
  - Web UI（将来的に実装）
  - 自動同期（Zoom等からの自動取得）

### 4.2 メタデータ

- **必須項目**:
  - CA ID
  - 通話日時
- **任意項目**:
  - 求職者名
  - 会議識別子
  - 備考

---

## 5. 出力データ

### 5.1 文字起こしテキスト

- **形式**: UTF-8エンコーディングのプレーンテキスト
- **保存場所**: `data/audio/transcripts/`
- **命名規則**: 元の音声ファイル名と同じ（拡張子のみ `.txt` に変更）

### 5.2 フィードバックレポート

- 既存のフィードバックシステムと同じ形式
- 出力先: `data/exports/feedback/`
- Slack通知も既存システムと同様

### 5.3 処理ログ

- 音声ファイル処理の各ステップのログ
- エラー発生時の詳細ログ
- 保存場所: `logs/audio_processing.log`

---

## 6. 実装アプローチ

### 6.1 フェーズ1: 基本機能（MVP）

**目標**: 音声ファイルをアップロードし、文字起こし→フィードバック生成まで自動実行

**実装項目**:
1. 音声ファイルのアップロード・保存機能（CLI）
2. OpenAI Whisper APIを使った文字起こし
3. 既存フィードバックシステムとの統合
4. 基本的なエラーハンドリング

**期間見積もり**: 2-3週間

### 6.2 フェーズ2: 改善・拡張

**目標**: 使いやすさと精度の向上

**実装項目**:
1. メタデータの自動抽出機能強化
2. 専門用語辞書の導入
3. 処理状況の可視化（ログ・ダッシュボード）
4. リトライ機能の強化

**期間見積もり**: 1-2週間

### 6.3 フェーズ3: 自動化・最適化（将来）

**目標**: 完全自動化と運用効率化

**実装項目**:
1. Zoom等からの自動音声取得
2. Web UIでのアップロード・管理
3. 複数文字起こしサービスのフォールバック機能
4. 処理パフォーマンスの最適化

**期間見積もり**: 2-3週間

---

## 7. 依存関係と制約

### 7.1 外部サービス依存

- **文字起こしAPI**: OpenAI Whisper API / Google Cloud Speech-to-Text / Azure Speech Services
- **料金**: 従量課金（月間処理時間に応じて変動）

### 7.2 既存システムへの影響

- **既存フィードバックシステム**: 拡張のみ（既存機能への影響なし）
- **ストレージ**: 追加容量が必要
- **ネットワーク**: 文字起こしAPIへの通信が必要

### 7.3 技術的制約

- Python 3.10以上が必要
- 音声処理ライブラリ（pydub, whisper等）が必要
- ストレージ容量の確保が必要

---

## 8. 成功指標（KPI）

### 8.1 処理効率

- **目標**: 音声アップロードからフィードバック生成まで、平均30分以内
- **測定方法**: 処理時間のログ分析

### 8.2 文字起こし精度

- **目標**: 文字起こし精度95%以上（専門家による評価）
- **測定方法**: サンプルファイルでの手動評価

### 8.3 システム利用率

- **目標**: 月間100件以上の音声ファイル処理
- **測定方法**: 処理件数の集計

### 8.4 エラー率

- **目標**: 処理失敗率5%以下
- **測定方法**: 成功/失敗件数の集計

---

## 9. リスクと対策

### 9.1 技術的リスク

| リスク | 影響度 | 対策 |
|--------|--------|------|
| 文字起こしAPIの障害 | 高 | 複数APIのフォールバック機能 |
| 音声ファイルの破損 | 中 | ファイル検証機能、リトライ機能 |
| ストレージ容量不足 | 中 | 自動アーカイブ機能、容量監視 |

### 9.2 運用リスク

| リスク | 影響度 | 対策 |
|--------|--------|------|
| APIコストの増大 | 中 | コスト監視、使用量アラート |
| 個人情報漏洩 | 高 | アクセス制御、暗号化、監査ログ |
| 処理遅延 | 低 | 非同期処理、キューイング |

---

## 10. 将来の拡張（ロードマップ）

### 10.1 リアルタイム文字起こし

- 通話中のリアルタイム文字起こし
- リアルタイムフィードバック提示

### 10.2 音声品質分析

- 話し方の分析（速度、トーン等）
- 沈黙時間の分析
- 会話のバランス分析

### 10.3 多言語対応

- 英語対応の求職者対応
- 多言語でのフィードバック生成

### 10.4 機械学習による改善

- 文字起こし精度の向上（カスタムモデル）
- フィードバック生成の精度向上
- 異常検知（通話品質の自動検出）

---

## 11. 用語集

- **CA**: キャリアアドバイザー（Career Advisor）
- **PSS**: Professional Selling Skills（プロフェッショナル・セリング・スキル）
- **ADS**: Adaptive Dealer Selling（適応型セールス）
- **文字起こし**: 音声をテキストに変換する処理
- **Whisper**: OpenAIが開発した音声認識モデル

---

## 12. 関連ドキュメント

- [システム2: フィードバックシステム 要件定義](./01-requirements.md#3-システム2-フィードバックシステム)
- [フィードバックシステム 運用ガイド](./07-operations.md#2-フィードバックシステム運用)
- [CAマニュアル](../docs/ca-manual.md)

