# フィードバック履歴機能 - 繰り返し改善点の検出

## 機能概要

フィードバック生成時に、過去90日間の同じCAのフィードバック履歴を参照し、同じ改善点が繰り返されている場合、そのことを明確に指摘し、なぜ同じ問題が起こり続けているかを改善するためのフィードバックを追加します。

## 実装内容

### 1. フィードバック履歴の保存

- フィードバック生成時に自動的に履歴が保存されます
- 保存先: `data/feedback/history.json`
- 履歴には以下が含まれます：
  - CA ID
  - 日付・会議ID
  - 改善点のリスト
  - 総合スコア
  - フィードバックID

### 2. 繰り返し改善点の検出

過去90日間の同じCAのフィードバックから、同じ改善点が指摘されているかを自動検出します。

**検出方法:**
- 改善点のキーワード（先頭30文字）を抽出
- 過去のフィードバックの改善点と比較
- 類似している改善点が複数回指摘されている場合、繰り返しとして検出

### 3. フィードバックメッセージへの追加

繰り返し改善点が検出された場合、以下の情報が追加されます：

```
⚠️ 【重要】この改善点は過去X回指摘されています。
最後に指摘したのは YYYY-MM-DD でした。
同じことを繰り返さないためには、なぜこの問題が起こり続けているのか、
根本的な原因を考える必要があります。

考えられる原因：
• 改善方法が具体的でなかった？
• 改善の優先順位が低かった？
• 習慣化するまで時間がかかっている？

次回までに、この問題を解決するための具体的な行動計画を立て、
実行してください。同じ指摘を繰り返すことは、成長を妨げます。
```

## 使用例

### 例1: 初回のフィードバック

**改善点:**
- 【重要】ニーズの深掘りが不十分でした。

**フィードバック:**
通常の改善点の説明のみ

---

### 例2: 同じ改善点が2回目

**改善点:**
- 【重要】ニーズの深掘りが不十分でした。

**フィードバック:**
```
【重要】ニーズの深掘りが不十分でした。

⚠️ 【重要】この改善点は過去1回指摘されています。
最後に指摘したのは 2025-11-20 でした。
同じことを繰り返さないためには、なぜこの問題が起こり続けているのか、
根本的な原因を考える必要があります。

考えられる原因：
• 改善方法が具体的でなかった？
• 改善の優先順位が低かった？
• 習慣化するまで時間がかかっている？

次回までに、この問題を解決するための具体的な行動計画を立て、
実行してください。同じ指摘を繰り返すことは、成長を妨げます。
```

---

### 例3: 同じ改善点が3回目以降

**改善点:**
- 【必須】クロージング時の期限設定が曖昧でした。

**フィードバック:**
```
【必須】クロージング時の期限設定が曖昧でした。

⚠️ 【重要】この改善点は過去3回指摘されています。
最後に指摘したのは 2025-11-25 でした。
同じことを繰り返さないためには、なぜこの問題が起こり続けているのか、
根本的な原因を考える必要があります。

考えられる原因：
• 改善方法が具体的でなかった？
• 改善の優先順位が低かった？
• 習慣化するまで時間がかかっている？

次回までに、この問題を解決するための具体的な行動計画を立て、
実行してください。同じ指摘を繰り返すことは、成長を妨げます。
```

このように、3回目以降はさらに厳しく指摘されます。

## 動作の仕組み

### 1. フィードバック生成時

```
フィードバック生成
    ↓
過去のフィードバック履歴を検索（同じCA、過去90日間）
    ↓
改善点を比較して繰り返しを検出
    ↓
繰り返し改善点の情報をフィードバックに追加
    ↓
履歴に保存
    ↓
Slack通知
```

### 2. 履歴の保存

- 自動的に `data/feedback/history.json` に保存
- フィードバック生成のたびに履歴が更新される
- JSON形式で、人間が読める形式で保存

### 3. 検索期間

- デフォルト: 過去90日間
- 設定可能（将来的に拡張可能）

## データ形式

### 履歴ファイル (data/feedback/history.json)

```json
{
  "feedbacks": [
    {
      "ca_id": "FUKUYAMA",
      "date": "2025-11-28",
      "meeting_id": "test-slack-001",
      "improvement_points": [
        "【重要】ニーズの深掘りが不十分でした。",
        "【必須】反論や懸念への対応が弱かったです。"
      ],
      "overall_score": 2.8,
      "feedback_id": "2025-11-28_FUKUYAMA_test-slack-001",
      "created_at": "2025-11-28T10:30:00"
    }
  ],
  "last_updated": "2025-11-28T10:30:00"
}
```

## 特徴

### 1. 自動検出

- フィードバック生成時に自動的に検出
- 追加の設定や操作は不要

### 2. 厳しくも建設的

- 繰り返しを明確に指摘
- なぜ起こっているかを考えるよう促す
- 具体的な行動計画を立てるよう要求

### 3. 成長志向

- 単に指摘するだけでなく、根本原因を考えるよう促す
- 改善のための具体的なアクションを要求

## 今後の拡張

1. **より高度な類似度判定**
   - キーワードマッチングから、より高度な類似度判定へ
   - 自然言語処理を使った改善点の類似度判定

2. **カテゴリー別の集計**
   - 同じカテゴリー（ニーズ把握、クロージングなど）の改善点を集計
   - 傾向分析レポートの生成

3. **改善率の追跡**
   - 改善点が解決されているかの追跡
   - 改善率の可視化

## 注意事項

- 履歴は自動的に保存されますが、手動で削除・編集することも可能です
- 履歴ファイルが大きくなりすぎた場合は、定期的なクリーンアップを推奨します
- CA IDが正しく設定されている必要があります（履歴検索のため）

